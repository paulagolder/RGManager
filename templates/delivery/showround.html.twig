{# views/delivery/showone.html.twig #}

{% extends 'dvymaster.html.twig' %}


{% block stylesheets %}
{{ parent() }}
<link href="{{ asset('/css/delivery.css') }}" rel="stylesheet" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
<link href="{{ asset('/css/tree.css') }}" rel="stylesheet" />
{% endblock %}
{% block js %}
{{ parent() }}
<script src="{{asset('js/maps.js')}}"></script>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
<script src="{{asset('js/L.KML.js')}}"></script>
<script src="{{asset('js/tree.js')}}"></script>
{% endblock %}


{% block middle %}
<div class="delivery">
  {% if message %}
  <div class="heading row">
    <div class="label">Delivery </div>
  </div>
  <H1> No deliverys found </H1>

  {% else %}

<div class="heading row">
    <div class="label"> Delivery </div>
    <div class="value"> {{delivery.deliveryId}}:</div>
    <div class="value"> {{delivery.Name}}</div>
    <div class="value">({{delivery.Households}})</div>
    <div class="button  right"> <a class="button" href = "{{back}}" >{{'back'}} </a> </div>
  </div>
  <div class="heading row">
    <div class="label" >RoundID:{{around.roundid}}</div>
    <div class="name" >{{around.name}}</div>
    <div  class="num" >{{around.households}}</div>
    <div  class="num" >{{around.deliveries}}</div>
    <div  class="button" ></div>
  </div>

  <div class="list" >
    {% set c=0 %}
    {% for key ,ardgroup in roadgroups %}

    <div class="roadgroup row">
      <div class="shorttext  colour_{{c}}">{{ardgroup.roadgroupid}}</div>
      <div class="mediumtext">{{ardgroup.name}}</div>
      <div class="num">{{ardgroup.households}}</div>
      <div class="button wide" >
        <a class="wide button" href = "/delivery/removeroadgroup/{{delivery.deliveryId}}/{{around.roundid}}/{{ardgroup.roadgroupid}}" >Remove</a>
      </div>
    </div>
    {% set c= c + 1 %}
    {% endfor %}
  </div>

  <div class="subheading row">
    <div class="name" >Roadgroups not allocated to a Delivery Round</div>
  </div>

  <ul id="tree"  >
    {% for key ,asubgroup in rgstree %}
    <li><span class="box"> {{key}}:{{ asubgroup.group.Name}}</span>
    <ul class="nested">
      {% for key2 ,arggroup in asubgroup["children"] %}
      <li ><span class="box"> {{key2}}:{{arggroup.group.Name}}</span><span > <a class="wide button" href = "/delivery/addallroadgroups/{{delivery.deliveryId}}/{{around.roundid}}/{{key2}}" >Add all roadgroups</a></span>
        <ul class="nested">
        {% for key3 ,arg in arggroup["children"] %}
        <li>
            <div class=" roadgroup row">
              <div class="rgid" >{{key3}}: </div>
              <div class="name" >{{arg.name }}</div>
              <div class="num" >{{arg.households }}</div>
              <div class="button wide" >
                <a class="wide button" href = "/delivery/addroadgroup/{{delivery.deliveryId}}/{{around.roundid}}/{{key3}}" >Add to Round</a>
              </div>
            </div>
        </li>
        {% endfor %}
        </ul>
      {% endfor %}
      </li>
    </ul>
     </li>
    {% endfor %}
    </ul>
{% endif %}
<div class="map" >
  <div id="wmapid" ></div>
</div>
{% set jslocation = delivery.getjson() %}
{% set abounds = bounds | json_encode | raw %}
<script>
  toggle();
</script>
<script >

  var mymap = myWMap("{{jslocation}}");
  var bounds = null;
  var wardlayer = null;
  var fgroup =  new L.featureGroup();

  var i=0;

      {% for keyrg, rg in roadgroups %}
      {% if rg.kml  %}
      var htmltext = "<html> <h1>{{keyrg}}</h1><div> <a class=\"button\" href = \"/delivery/removeroadgroup/{{delivery.deliveryId}}/{{around.roundid}}/{{keyrg}}\" >REMOVE</a></div>";
        var style = {"color":  getColor(i) , "weight": 4 ,  "clickable": true ,"opacity": 1.0, "fillOpacity": 1.0 };
        var  kml = "{{rg.kml}}";
        var path = "{{mappath}}roadgroups/"+kml;
        if(kml)
        {
           makeKMLLayer(mymap,path,style,true,htmltext);
        }
      {% endif %}
      i=i+1;
      {% endfor %}

      var kml = "{{delivery.KML}}";
      var path = "{{mappath}}outlines/"+kml;
      if(kml)
      {
      var style = {"color": "#0000FF","fillcolor": "#FF00FF", "weight": 5 ,  "clickable": true,"opacity": 0.9, "fillOpacity": 0.0 };
      makeOutlineKml(mymap,path,style,false,"{{delivery.name}}")
      }
      setMarkers(mymap,"{{abounds}}");
      setBounds2(mymap,"{{abounds}}");


    </script>
</div>
{% endblock %}
